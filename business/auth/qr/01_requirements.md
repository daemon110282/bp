**Функциональные требования — Авторизация в ЛК по QR через МП**

---

**Контекст задачи**

На основе задания: веб генерирует одноразовый QR (qr_token + expires_in / qr_code_base64), веб ожидает событий по каналу, МП сканирует QR или открывает deep link, подтверждает авторизацию, сервер проверяет контекст и выполняет обмен токенов через внешний провайдер авторизации. QR помечается как использованный; сессия веба создаётся автоматически.

---

**Требования по модулям**

**Модуль: Генерация QR (QR Token)**

- Система должна генерировать уникальный одноразовый QR‑токен (QRToken) с атрибутами: `qr_token`, `expires_in`, `qr_code_base64`, `status`, `created_at`, `init_timestamp`, `uid`, `attempts`.
- Система должна сохранять данные сущности `QRToken` в хранилище данных и обеспечивать возможность прочитать запись по `qr_token`.
- Система должна предоставлять срок жизни (expires_in) для каждого `QRToken` и помечать токен как просроченный после истечения срока.
- Система должна ограничивать количество попыток использования `QRToken` и блокировать токен при превышении лимита попыток.
- Система должна помечать `QRToken` как использованный при успешном подтверждении и запрещать повторное использование.

**Модуль: Канал событий и подписка (Клиент-Веб)**

- Система должна предоставлять канал для подписки веб‑клиента на события по конкретному `qr_token` (инициализация, сканирование, подтверждение, отклонение, истечение).
- Система должна отправлять событие и/или ответ владельцу сессии веба при каждом изменении состояния `QRToken`.
- Система должна хранить и возвращать текущее состояние `QRToken` по запросу веб‑клиента.

**Модуль: Взаимодействие с мобильным приложением (МП)**

- Система должна принимать уведомление о сканировании `QRToken` от МП и отмечать `QRToken` как «scan pending» с указанием `mobile_device_id` и `scan_timestamp`.
- Система должна предоставлять возможность МП направлять команду подтверждения (`confirm`) или отклонения (`reject`) для конкретного `QRToken`.
- Система должна публиковать события о сканировании/подтверждении/отклонении в шину событий (Service Bus) для заинтересованных подписчиков.

**Модуль: Подтверждение и обмен токенов**

- Система должна проверять целостность и валидность контекста подтверждения (совпадение `uid`, `init_timestamp`, контекстных атрибутов: `User‑Agent`, `IP`, метки времени) перед сменой статуса `QRToken` на подтверждён.
- Система должна инициировать обмен учетных данных с внешним провайдером авторизации для получения пар токенов доступа и обновления (AuthToken) после успешного подтверждения со стороны МП.
- Система должна доставлять веб‑клиенту результат попытки обмена (успех с выдачей AT/RT либо детализированная ошибка) и менять состояние `QRToken` в зависимости от результата.

**Модуль: Управление сессией веб-клиента**

- Система должна создавать веб‑сессию для пользователя и выдавать необходимые сессионные данные веб‑клиенту после успешного получения AT/RT от провайдера авторизации.
- Система должна обеспечивать корректный жизненный цикл сессии: создание, обновление и завершение в соответствии с политиками аутентификации.

**Модуль: Безопасность и валидация**

- Система должна формировать защищённый контекст для `QRToken` на основе `uid`, `init_timestamp` и контекстных атрибутов (User‑Agent, IP) и проверять целостность этого контекста при подтверждении.
- Система должна отвергать подтверждения, если контекст подтверждения существенно отличается от контекста инициализации (например, несовпадение обязательных атрибутов или подозрительные временные несоответствия).
- Система должна логировать события безопасности (подозрительные сканирования, отклонения, попытки повторного использования, нарушения контекста) в хранилище аудита.

**Модуль: Шина событий (Service Bus)**

- Система должна публиковать логические события по жизненному циклу `QRToken` (QR.Initiated, QR.Scanned, QR.Confirmed, QR.Rejected, QR.Expired).
- Система должна позволять компонентам подписываться на перечисленные события для асинхронной обработки (рассылка/подписка).
- Система должна поддерживать асинхронный вызов удалённой процедуры (RPC) к внешним субсистемам через шину для операций, связанных с подтверждением и обменом токенов.

**Модуль: Логирование, метрики и мониторинг**

- Система должна сохранять метрики по времени авторизации, проценту успешных QR‑логинов, количеству отказов по причинам безопасности и ошибкам обмена токенов.
- Система должна сохранять журнал операций для сущности `QRToken` с возможностью прочитать историю по `qr_token`.

**Требования к пользовательским сценариям (проверяемые критерии)**

- Система должна позволять веб‑клиенту инициировать сценарий авторизации: сгенерировать `QRToken`, начать ожидание подтверждения и получить финальный статус (успех/ошибка) в пределах указанного `expires_in`.
- Система должна позволять мобильному приложению выполнить сканирование и отправить подтверждение/отклонение, и это действие должно привести к соответствующему изменению состояния `QRToken`.
- Система должна гарантировать, что при успешном подтверждении веб‑клиент получает корректный набор токенов для аутентификации и сессия создаётся автоматически.

---

**Словарь сущностей (кратко)**

- `QRToken` — сущность, хранящая `qr_token`, `qr_code_base64`, `expires_in`, `status`, `created_at`, `init_timestamp`, `uid`, `attempts`.
- `AuthToken` — результат обмена у внешнего провайдера: `access_token`, `refresh_token`, `expires_in`.
- `WebSession` — сессионная сущность веб‑клиента с `session_id`, `user_id`, `created_at`.

---

Эти требования являются атомарными, проверяемыми и не содержат низкоуровневых технических деталей. При желании могу разбить их на acceptance criteria или Gherkin‑сценарии.
