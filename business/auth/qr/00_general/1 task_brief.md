# Авторизация в ЛК по QR через МП

## Бизнес‑цель

Получить безопасный и удобный способ входа в веб-версию личного кабинета (ЛК) без ввода логина\телефона\email и пароля, путем сканирования QR-кода мобильным приложением (МП), чтобы упростить процесс авторизации в личном кабинете

## Проблема

Пользователи испытывают сложности при вводе учётных данных на вебе: требуется безпарольный, защищённый канал авторизации с подтверждением со стороны МП.

## Целевая аудитория

Конечные пользователи ЛК с установленным мобильным приложением.

## Ожидаемый результат

- Веб‑страница генерирует одноразовый QR (qr_token + expires_in / qr_code_base64).
- Веб подключается к WebSocket (/api/v1/ws/qr) и ожидает событий по каналу.
- МП сканирует QR или открывает deep link, подтверждает авторизацию в приложении.
- Сервер проверяет подпись/контекст (User‑Agent, IP, uid, timestamps, SHA‑256), выполняет обмен токенов через Keycloak (Token Exchange / impersonate) и отправляет в веб AT/RT (или статус/ошибку).
- QR помечается как использованный; сессия пользователя в вебе создаётся автоматически.

## Ключевые ограничения

- Одноразовость QR: срок жизни (expires_in) и ограничение по количеству генераций/попыток.
- Безопасность: формирование токена как SHA‑256 от uid+init_timestamp+User‑Agent+IP; проверка User‑Agent и IP.
- Обмен токенов через Keycloak (Token Exchange/Impersonate)
- Канал связи — WebSocket (/api/v1/ws/qr) для init/subscribe/refresh/confirm/reject событий.

## Критерии успеха

- Пользователь может выполнить вход в веб‑ЛК через МП не более чем за N секунд (оперативность).
- QR одноразовый и не может быть повторно использован (безопасность).
- Корректная выдача AT/RT вебу после подтверждения МП; успешная сессия создана.
- Количество отказов по безопасности (подпись/IP/UA) ниже порогового значения.
- Логирование и метрики: время авторизации, % успешных QR‑логинов, rate ошибок по кодам (401/409/410) соответствуют SLA.
